<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>게임 마켓 - 내가 쓴 리뷰</title>
  <style>
    body {font-family: Arial, Helvetica, sans-serif; background:#f4f6f9; display:flex; justify-content:center; margin:0; padding:0}
    .container{width:90%;max-width:900px;background:#fff;margin-top:40px;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    h1{text-align:center;color:#333;margin-bottom:22px}
    .review{background:#fafafa;border-radius:10px;padding:20px;margin-bottom:18px;box-shadow:0 2px 8px rgba(0,0,0,0.04);position:relative}
    .reported-banner{position:absolute;top:-10px;left:-10px;background:#dc3545;color:#fff;font-weight:700;font-size:13px;padding:6px 10px;border-top-left-radius:10px;border-bottom-right-radius:8px}
    .review h2{margin:0 0 8px 0;color:#007BFF;font-size:18px}
    .criteria-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px 36px;margin-top:8px;margin-bottom:12px}
    .criteria{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:8px;padding:8px 12px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .criteria label{font-weight:700;color:#333}
    .stars{color:#FFD700;font-size:16px}
    .review-text{color:#444;font-size:15px;line-height:1.6;margin-top:10px;margin-bottom:8px;white-space:pre-line}
    .review small{color:#666}
    .review.reported{border:2px solid #dc3545;background:#fff5f5}
    .back-btn{text-align:center;margin-top:18px}
    .link-btn{display:inline-block;background:#007BFF;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:700}
    .link-btn:hover{background:#0056b3}
  </style>
</head>
<body>
  <div class="container">
    <h1>✏️ 내가 쓴 리뷰</h1>

    <% if (!reviews || reviews.length === 0) { %>
      <p style="text-align:center;color:#666">아직 작성한 리뷰가 없습니다.</p>
    <% } else { %>
      <% reviews.forEach(r => { %>
        <div class="review <%= r.is_hidden ? 'reported' : '' %>" data-review-id="<%= r.review_id %>">
          <% if (r.is_hidden) { %>
            <div class="reported-banner">🚨 이 리뷰는 신고로 비공개 처리되었습니다.</div>
          <% } %>

          <h2><a href="/games/<%= r.game_id %>" style="color:inherit;text-decoration:none"><%= r.game_title || '제목 없음' %></a></h2>

          <div class="criteria-grid">
            <div class="criteria"><label>그래픽</label><span class="stars"><%= '★'.repeat(r.rating_graphic || 0) + '☆'.repeat(5 - (r.rating_graphic || 0)) %></span></div>
            <div class="criteria"><label>완성도</label><span class="stars"><%= '★'.repeat(r.rating_quality || 0) + '☆'.repeat(5 - (r.rating_quality || 0)) %></span></div>
            <div class="criteria"><label>재미 / 몰입감</label><span class="stars"><%= '★'.repeat(r.rating_fun || 0) + '☆'.repeat(5 - (r.rating_fun || 0)) %></span></div>
            <div class="criteria"><label>리플레이 가능성</label><span class="stars"><%= '★'.repeat(r.rating_replay || 0) + '☆'.repeat(5 - (r.rating_replay || 0)) %></span></div>
            <div class="criteria"><label>가격 만족도</label><span class="stars"><%= '★'.repeat(r.rating_price || 0) + '☆'.repeat(5 - (r.rating_price || 0)) %></span></div>
            <div class="criteria"><label>첫인상</label><span class="stars"><%= '★'.repeat(r.rating_first_impression || 0) + '☆'.repeat(5 - (r.rating_first_impression || 0)) %></span></div>
            <div class="criteria"><label>접근성</label><span class="stars"><%= '★'.repeat(r.rating_access || 0) + '☆'.repeat(5 - (r.rating_access || 0)) %></span></div>
            <div class="criteria"><label>경쟁력</label><span class="stars"><%= '★'.repeat(r.rating_competitive || 0) + '☆'.repeat(5 - (r.rating_competitive || 0)) %></span></div>
          </div>

          <div class="review-text"><%= r.comment || '' %></div>
          <p><small>작성일: <%= r.created_at ? (new Date(r.created_at)).toISOString().slice(0,10) : '-' %></small></p>
          <div style="margin-top:10px">
            <button class="link-btn delete-review-btn" data-review-id="<%= r.review_id %>" style="background:#dc3545">삭제</button>
          </div>
        </div>
      <% }) %>
    <% } %>

    <div class="back-btn">
      <a href="/users/my_page" class="link-btn">← 마이페이지로 돌아가기</a>
    </div>
  </div>
  <script>
    // attach delete handlers
    (function(){
      function showToast(msg){
        alert(msg); // simple fallback; you can replace with your toast UI
      }

      document.querySelectorAll('.delete-review-btn').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.preventDefault();
          const rid = this.dataset.reviewId;
          if (!confirm('정말 이 리뷰를 삭제하시겠습니까?')) return;
          fetch(`/users/reviews/${encodeURIComponent(rid)}/delete`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: ''
          }).then(r => {
            if (!r.ok) {
              if (r.status === 401) {
                // not logged in
                showToast('로그인이 필요합니다');
                return Promise.reject(new Error('로그인 필요'));
              }
              return r.text().then(t => {
                try { return JSON.parse(t); } catch(e){ throw new Error(t || '서버 오류'); }
              });
            }
            return r.text().then(t => { try { return JSON.parse(t); } catch(e){ return { success: true, message: t || '삭제되었습니다' }; } });
          }).then(js => {
            if (js && js.success) {
              // remove the review element from DOM
              const el = document.querySelector('[data-review-id="'+rid+'"]');
              if (el && el.parentNode) el.parentNode.removeChild(el);
              showToast(js.message || '삭제되었습니다');
            } else {
              showToast((js && js.message) || '삭제에 실패했습니다');
            }
          }).catch(err => { console.error(err); showToast('서버 오류'); });
        });
      });
    })();
  </script>
</body>
</html>
