<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê²Œì„ ë§ˆì¼“ - ë‚´ê°€ ì“´ ë¦¬ë·°</title>
  <style>
    body {font-family: Arial, Helvetica, sans-serif; background:#f4f6f9; display:flex; justify-content:center; margin:0; padding:0}
    .container{width:90%;max-width:900px;background:#fff;margin-top:40px;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
    h1{text-align:center;color:#333;margin-bottom:22px}
    .review{background:#fafafa;border-radius:10px;padding:20px;margin-bottom:18px;box-shadow:0 2px 8px rgba(0,0,0,0.04);position:relative}
    .reported-banner{position:absolute;top:-10px;left:-10px;background:#dc3545;color:#fff;font-weight:700;font-size:13px;padding:6px 10px;border-top-left-radius:10px;border-bottom-right-radius:8px}
    .review h2{margin:0 0 8px 0;color:#007BFF;font-size:18px}
    .criteria-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px 36px;margin-top:8px;margin-bottom:12px}
    .criteria{display:flex;justify-content:space-between;align-items:center;background:#fff;border-radius:8px;padding:8px 12px;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
    .criteria label{font-weight:700;color:#333}
    .stars{color:#FFD700;font-size:16px}
    .review-text{color:#444;font-size:15px;line-height:1.6;margin-top:10px;margin-bottom:8px;white-space:pre-line}
    .review small{color:#666}
    .review.reported{border:2px solid #dc3545;background:#fff5f5}
    .back-btn{text-align:center;margin-top:18px}
    .link-btn{display:inline-block;background:#007BFF;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;font-weight:700}
    .link-btn:hover{background:#0056b3}
  </style>
</head>
<body>
  <div class="container">
    <h1>âœï¸ ë‚´ê°€ ì“´ ë¦¬ë·°</h1>

    <% if (!reviews || reviews.length === 0) { %>
      <p style="text-align:center;color:#666">ì•„ì§ ì‘ì„±í•œ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    <% } else { %>
      <% reviews.forEach(r => { %>
        <div class="review <%= r.is_hidden ? 'reported' : '' %>" data-review-id="<%= r.review_id %>">
          <% if (r.is_hidden) { %>
            <div class="reported-banner">ğŸš¨ ì´ ë¦¬ë·°ëŠ” ì‹ ê³ ë¡œ ë¹„ê³µê°œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
          <% } %>

          <h2><a href="/games/<%= r.game_id %>" style="color:inherit;text-decoration:none"><%= r.game_title || 'ì œëª© ì—†ìŒ' %></a></h2>

          <div class="criteria-grid">
            <div class="criteria"><label>ê·¸ë˜í”½</label><span class="stars"><%= 'â˜…'.repeat(r.rating_graphic || 0) + 'â˜†'.repeat(5 - (r.rating_graphic || 0)) %></span></div>
            <div class="criteria"><label>ì™„ì„±ë„</label><span class="stars"><%= 'â˜…'.repeat(r.rating_quality || 0) + 'â˜†'.repeat(5 - (r.rating_quality || 0)) %></span></div>
            <div class="criteria"><label>ì¬ë¯¸ / ëª°ì…ê°</label><span class="stars"><%= 'â˜…'.repeat(r.rating_fun || 0) + 'â˜†'.repeat(5 - (r.rating_fun || 0)) %></span></div>
            <div class="criteria"><label>ë¦¬í”Œë ˆì´ ê°€ëŠ¥ì„±</label><span class="stars"><%= 'â˜…'.repeat(r.rating_replay || 0) + 'â˜†'.repeat(5 - (r.rating_replay || 0)) %></span></div>
            <div class="criteria"><label>ê°€ê²© ë§Œì¡±ë„</label><span class="stars"><%= 'â˜…'.repeat(r.rating_price || 0) + 'â˜†'.repeat(5 - (r.rating_price || 0)) %></span></div>
            <div class="criteria"><label>ì²«ì¸ìƒ</label><span class="stars"><%= 'â˜…'.repeat(r.rating_first_impression || 0) + 'â˜†'.repeat(5 - (r.rating_first_impression || 0)) %></span></div>
            <div class="criteria"><label>ì ‘ê·¼ì„±</label><span class="stars"><%= 'â˜…'.repeat(r.rating_access || 0) + 'â˜†'.repeat(5 - (r.rating_access || 0)) %></span></div>
            <div class="criteria"><label>ê²½ìŸë ¥</label><span class="stars"><%= 'â˜…'.repeat(r.rating_competitive || 0) + 'â˜†'.repeat(5 - (r.rating_competitive || 0)) %></span></div>
          </div>

          <div class="review-text"><%= r.comment || '' %></div>
          <p><small>ì‘ì„±ì¼: <%= r.created_at ? (new Date(r.created_at)).toISOString().slice(0,10) : '-' %></small></p>
          <div style="margin-top:10px">
            <button class="link-btn delete-review-btn" data-review-id="<%= r.review_id %>" style="background:#dc3545">ì‚­ì œ</button>
          </div>
        </div>
      <% }) %>
    <% } %>

    <div class="back-btn">
      <a href="/users/my_page" class="link-btn">â† ë§ˆì´í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>
  <script>
    // attach delete handlers
    (function(){
      function showToast(msg){
        alert(msg); // simple fallback; you can replace with your toast UI
      }

      document.querySelectorAll('.delete-review-btn').forEach(btn => {
        btn.addEventListener('click', function(e){
          e.preventDefault();
          const rid = this.dataset.reviewId;
          if (!confirm('ì •ë§ ì´ ë¦¬ë·°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          fetch(`/users/reviews/${encodeURIComponent(rid)}/delete`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: ''
          }).then(r => {
            if (!r.ok) {
              if (r.status === 401) {
                // not logged in
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                return Promise.reject(new Error('ë¡œê·¸ì¸ í•„ìš”'));
              }
              return r.text().then(t => {
                try { return JSON.parse(t); } catch(e){ throw new Error(t || 'ì„œë²„ ì˜¤ë¥˜'); }
              });
            }
            return r.text().then(t => { try { return JSON.parse(t); } catch(e){ return { success: true, message: t || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤' }; } });
          }).then(js => {
            if (js && js.success) {
              // remove the review element from DOM
              const el = document.querySelector('[data-review-id="'+rid+'"]');
              if (el && el.parentNode) el.parentNode.removeChild(el);
              showToast(js.message || 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            } else {
              showToast((js && js.message) || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
            }
          }).catch(err => { console.error(err); showToast('ì„œë²„ ì˜¤ë¥˜'); });
        });
      });
    })();
  </script>
</body>
</html>
